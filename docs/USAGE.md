# Руководство пользователя

## Обзор приложения

Meshtastic Android — это клиент для связи с устройствами Meshtastic по протоколу BLE (Bluetooth Low Energy). Приложение позволяет:
- Подключаться к устройствам
- Мониторить состояние сети и устройства
- Настраивать параметры безопасности (PSK)
- Просматривать список узлов сети

## Структура интерфейса

Приложение состоит из 4 основных экранов, доступных через нижнюю навигацию:

1. **Подключение** — поиск и подключение по BLE
2. **Статус** — мониторинг состояния и телеметрия
3. **Узлы** — список участников сети
4. **Настройки** — конфигурация канала и PSK

---

## 1. Экран "Подключение"

### 1.1 Первое подключение

#### Шаг 1: Подготовка
1. Включите устройство Meshtastic
2. Убедитесь, что Bluetooth включён на телефоне
3. Разрешите приложению доступ к BLE и геолокации

#### Шаг 2: Сканирование
1. Откройте вкладку **"Подключение"**
2. Нажмите кнопку **"Поиск устройств"**
3. Дождитесь завершения сканирования (6 секунд)

**Что происходит:**
- Приложение сканирует BLE устройства с UUID сервиса Meshtastic
- Найденные устройства отображаются в списке с именем и MAC-адресом
- Первое найденное устройство выбирается автоматически

#### Шаг 3: Подключение
1. Проверьте выбранное устройство в списке
2. Нажмите кнопку **"Подключиться"**
3. Дождитесь установки соединения

**Индикаторы состояния:**
```
"Bluetooth включен. Готов к поиску устройств." → зелёный цвет
"Поиск BLE устройств Meshtastic..." → прогресс
"Подключение..." → идёт подключение
"Подключено: <имя устройства>" → успех (зелёный)
```

### 1.2 Проверка подключения

После успешного подключения:
- Статус меняется на **"Подключено"**
- Появляются входящие данные в поле **"Последние входящие байты"**
- Активируется кнопка **"Отправить тест (ping)"**

#### Отправка тестового пакета

Нажмите **"Отправить тест (ping)"** для проверки связи:
```
Приложение → ToRadio.want_config_id → Устройство
Устройство → FromRadio (my_info, node_info, config) → Приложение
```

**Ожидаемый результат:**
- В поле "Последние входящие байты" появятся hex-данные
- На экране "Статус" обновится информация

### 1.3 Типичные проблемы

#### Устройство не найдено
```
Причина: BLE выключен или устройство далеко
Решение:
- Проверьте Bluetooth на телефоне
- Подойдите ближе к устройству (< 5 метров)
- Перезапустите устройство Meshtastic
```

#### Не удаётся подключиться
```
Причина: Устройство занято другим подключением
Решение:
- Отключите другие BLE клиенты
- Перезагрузите устройство Meshtastic
- Перезапустите Bluetooth на телефоне
```

---

## 2. Экран "Статус"

### 2.1 Общая информация

Экран "Статус" отображает:
- Состояние BLE соединения
- Телеметрию устройства
- Расшифрованные FromRadio сообщения
- Сырые входящие данные (для диагностики)

### 2.2 Блоки информации

#### Состояние
```
Отображает: текущее состояние BLE
Значения:
  - "DISCONNECTED" — отключено
  - "SCANNING" — идёт поиск
  - "CONNECTING" — подключение
  - "CONNECTED" — подключено
  - "ERROR" — ошибка
```

#### Сообщение
```
Отображает: текстовый статус или последнее событие
Примеры:
  - "Bluetooth включен. Готов к поиску устройств."
  - "Подключено: Meshtastic_a3b2"
  - "Подключено: my_num=123456789"
```

#### Детали устройства
```
Поля:
  - Имя устройства (device_name)
  - Номер узла (node_num)
  - Версия прошивки (firmware_version)
  - Уровень батареи (battery_percent)
  - SNR (signal-to-noise ratio)
  - Время последнего приёма (last_heard)
  - Timestamp последних данных (last_rx)
```

#### Последние входящие байты (hex)
```
Отображает: сырые данные FromRadio в hex-формате
Пример:
  0A 12 08 01 12 0E 0A 0C 4D 65 73 68 74 61 73 74 69 63

Назначение: диагностика BLE транспорта
```

#### Расшифрованное FromRadio сообщение
```
Отображает: человекочитаемую сводку protobuf
Примеры:
  - "FromRadio id=123 MY_INFO"
  - "FromRadio id=124 NODE_INFO"
  - "FromRadio id=125 PACKET on port TEXT_MESSAGE_APP"
  - "FromRadio id=126 CONFIG update"
```

### 2.3 Интерпретация данных

#### Батарея устройства
```
100% → полный заряд
50-99% → нормально
20-49% → низкий заряд
< 20% → критически низко
—  → данные отсутствуют
```

#### SNR (Signal-to-Noise Ratio)
```
> 10 dB → отличный сигнал
5-10 dB → хороший
0-5 dB → удовлетворительный
< 0 dB → плохой (возможны потери)
—  → данные отсутствуют
```

#### Время последнего приёма
```
Формат: epoch seconds (секунды с 1970-01-01)
Пример: 1738540800 = 2026-02-03 12:00:00

Если долго не обновляется (> 5 минут):
  - Устройство выключено
  - Связь потеряна
  - Нет активности в сети
```

### 2.4 Мониторинг в реальном времени

**Что обновляется автоматически:**
- Входящие байты (при каждом FromRadio)
- Расшифрованное сообщение (при каждом пакете)
- Телеметрия (при получении NODE_INFO)
- Версия прошивки (при получении METADATA)

**Частота обновлений:**
- Зависит от активности в сети Meshtastic
- Минимум 1 пакет каждые 30-60 секунд (heartbeat)

---

## 3. Экран "Узлы"

### 3.1 Список узлов сети

Отображает все узлы, от которых получены данные.

#### Информация по каждому узлу
```
Заголовок: Long Name или Short Name или User ID
Подзаголовок: ID и Node Number
Метаданные:
  - Батарея (если доступно)
  - SNR
  - Количество хопов
  - Канал (если не PRIMARY)
  - "via MQTT" (если через MQTT мост)
Координаты: широта и долгота (если доступно)
Время: last heard (epoch seconds)
```

### 3.2 Пример карточки узла

```
╔═══════════════════════════════════╗
║ TeamLeader                        ║ ← Long Name
║ ID: !a1b2c3d4 | Num: 123456789   ║ ← User ID и Node Number
║ Batt: 85%  SNR: 9.5  Hops: 1     ║ ← Метаданные
║ Lat: 55.75222  Lon: 37.61556     ║ ← Координаты
║ last heard: 1738540800            ║ ← Timestamp
╚═══════════════════════════════════╝
```

### 3.3 Интерпретация данных

#### Количество хопов
```
0 → прямое соединение
1 → через один ретранслятор
2+ → через несколько ретрансляторов

Чем больше хопов, тем больше задержка и потери.
```

#### Via MQTT
```
Означает, что узел подключен через MQTT мост.
Такие узлы могут быть за пределами радиусиуса действия LoRa.
```

---

## 4. Экран "Настройки"

### 4.1 Назначение

Экран позволяет:
- Локально сохранять черновик настроек
- Применять настройки на устройство по BLE

### 4.2 Поля настроек

#### Имя узла
```
Назначение: идентификатор вашего устройства в сети
Формат: текст до 32 символов
Пример: "TEAM-1", "BaseStation", "Mobile-Alpha"

⚠️ В текущей версии сохраняется только локально
```

#### Регион
```
Назначение: частотный план LoRa
Значения:
  - EU_868 (Европа, Россия)
  - US (США, Канада)
  - CN (Китай)
  - JP (Япония)
  - ANZ (Австралия, Новая Зеландия)
  
⚠️ В текущей версии сохраняется только локально
```

#### Имя канала
```
Назначение: имя канала для группового общения
Формат: текст до 11 символов
Пример: "GROUP", "RESCUE", "TEAM-A"

✓ Применяется на устройство
```

#### Ключ канала / PSK
```
Назначение: Pre-Shared Key для шифрования
Формат: строка UTF-8
Рекомендуемая длина: 16 или 32 символа
Пример: "MySecretKey12345" (16 символов)

✓ Применяется на устройство
```

### 4.3 Сохранение черновика

Нажмите кнопку **"Сохранить"**:
- Все поля сохраняются в `SharedPreferences`
- Данные остаются после перезапуска приложения
- Можно повторно применить позже

### 4.4 Применение на устройство

#### Подготовка
1. Убедитесь, что устройство **подключено** (статус CONNECTED)
2. Заполните **обязательные поля**:
   - Имя канала
   - PSK

#### Процесс применения
1. Нажмите **"Применить на устройство"**
2. Приложение отправит admin-пакет по BLE:
```
ToRadio:
  packet:
    decoded:
      portnum: ADMIN_APP (6)
      payload: FromRadio.channel
        channel:
          index: 0
          role: PRIMARY
          settings:
            name: "YOUR_CHANNEL"
            psk: <bytes_utf8>
```

3. Дождитесь toast-уведомления:
   - ✓ "Настройки отправлены" → успех
   - ✗ "Не удалось отправить" → ошибка

#### Проверка применения

После отправки:
1. Перейдите на вкладку **"Статус"**
2. Дождитесь FromRadio пакетов
3. Проверьте, что связь не потеряна

**Важно:** Смена PSK требует перезапуска устройства для вступления в силу.

### 4.5 Рекомендации по PSK

#### Безопасность
```
Слабый PSK: "1234", "password", "test"
Средний PSK: "MySecretKey2024"
Сильный PSK: "aB3$kL9@mN7*qP2!"

Рекомендации:
- Используйте минимум 16 символов
- Комбинируйте буквы, цифры, символы
- Не используйте словарные слова
- Меняйте PSK периодически
```

#### Длина PSK
```
Meshtastic поддерживает:
  0 байт  → без шифрования
  16 байт → AES-128
  32 байта → AES-256

UTF-8 строка преобразуется в байты, поэтому:
  "0123456789ABCDEF" → 16 байт (ASCII)
  "Привет" → 12 байт (кириллица по 2 байта/символ)
```

### 4.6 Частые проблемы

#### "Не удалось отправить"
```
Причина 1: Нет подключения
Решение: Проверьте статус на вкладке "Подключение"

Причина 2: Пустое имя канала или PSK
Решение: Заполните все обязательные поля

Причина 3: Устройство не отвечает
Решение: Перезапустите устройство Meshtastic
```

#### Настройки не применились
```
Проблема: После отправки устройство не изменило канал
Решение:
  - Дождитесь 10-15 секунд
  - Перезагрузите устройство Meshtastic
  - Повторите применение настроек
```

---

## 5. Сценарии использования

### 5.1 Быстрая проверка связи

```
1. Подключение → Поиск → Подключиться
2. Статус → проверить "Расшифрованное сообщение"
3. Узлы → убедиться, что узлы отображаются
4. Подключение → Отправить тест → проверить ответ
```

**Время:** ~2 минуты  
**Цель:** Убедиться, что BLE работает корректно

### 5.2 Настройка канала для группы

```
Подготовка:
  - Договоритесь о PSK с командой
  - Выберите короткое имя канала

Действия:
  1. Настройки → введите имя и PSK
  2. Сохранить (локально)
  3. Применить на устройство
  4. Дождитесь подтверждения
  5. Перезагрузите устройство
  6. Проверьте связь на вкладке "Узлы"
```

**Время:** ~5 минут  
**Цель:** Настроить безопасный канал

### 5.3 Мониторинг сети в полевых условиях

```
1. Подключитесь к устройству
2. Оставьте на вкладке "Узлы"
3. Наблюдайте за появлением новых узлов
4. Периодически проверяйте SNR и батарею
5. При проблемах смотрите "Статус"
```

**Время:** постоянно  
**Цель:** Контроль состояния mesh-сети

---

## 6. Диагностика

### 6.1 Проверка качества связи

#### BLE соединение
```
Хорошо: Входящие байты обновляются каждые 1-5 секунд
Средне: Обновления раз в 10-30 секунд
Плохо: Обновления реже 1 раза в минуту

Решение при плохом качестве:
  - Подойдите ближе к устройству
  - Уберите препятствия (металл, стены)
  - Перезапустите BLE подключение
```

#### LoRa сеть
```
Хорошо: SNR > 5 dB, узлы обновляются часто
Средне: SNR 0-5 dB, узлы появляются периодически
Плохо: SNR < 0 dB, узлы пропадают

Решение:
  - Поднимите антенну выше
  - Смените расположение устройства
  - Проверьте настройки региона
```

### 6.2 Чтение логов

Для углублённой диагностики используйте ADB:

```powershell
# Фильтр по приложению
adb logcat | Select-String "Meshtastic"

# Только BLE логи
adb logcat | Select-String "BleManager"

# Ошибки
adb logcat *:E | Select-String "com.example.meshtastic"
```

---

## 7. Лучшие практики

### 7.1 Экономия батареи телефона
- Отключайте BLE, когда не используете
- Не оставляйте приложение в фоне надолго
- Используйте "режим полёта" + BLE при необходимости

### 7.2 Безопасность
- Меняйте PSK регулярно
- Не передавайте PSK небезопасными каналами
- Используйте уникальные PSK для разных групп

### 7.3 Надёжность
- Периодически проверяйте подключение
- Держите приложение и прошивку устройства актуальными
- Делайте бэкапы настроек (записывайте PSK)
